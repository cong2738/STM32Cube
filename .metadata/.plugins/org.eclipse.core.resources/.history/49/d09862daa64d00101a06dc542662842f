/*
 * ap_main.c
 *
 *  Created on: Jun 19, 2025
 *      Author: kccistc
 */

#include "ap_main.h"

enum {
	START,
	STOP,
    LEFT,
    RIGHT };

button_handler_t hBtnLeft;
button_handler_t hBtnRight;
button_handler_t hBtnOnSTOP;

typedef struct {
		int msec;
		int sec;
		int min;
}clock_data_t;


void TIM2_IRQHandler(void) // 인터럽트 함수 Startup가보면 인터럽트벡터등 이름이 명시되어 있음
{
    FND_DisplayData();
    TIM_ClearUIF(TIM2);
}

int ap_main()
{
	int mode = 0;
	clock_data_t data[2];
    (data[mode].msec)++;
	if((data[mode].msec) == 100){
		(data[mode].msec) = 0;
		(data[mode].sec)++;
	}
	if((data[mode].sec) == 60) {
		(data[mode].sec) = 0;
		(data[mode].min)++;
	}
	if((data[mode].min) == 10) {
		(data[mode].min) = 0;
	}

	uint32_t watch_state = START;
    while (1) {
        switch (watch_state) {
        case START:
        	watch_state = STOP;
        	break;
        case STOP:
            if (Button_GetState(&hBtnLeft) == ACT_PUSHED) {
            	watch_state = LEFT;
            } else if (Button_GetState(&hBtnRight) == ACT_PUSHED) {
            	watch_state = RIGHT;
            }
            break;
        case LEFT:
            if (Button_GetState(&hBtnOnSTOP) == ACT_PUSHED) {
            	watch_state = STOP;
            } else if (Button_GetState(&hBtnRight) == ACT_PUSHED) {
            	watch_state = RIGHT;
            }
            break;
        case RIGHT:
            if (Button_GetState(&hBtnOnSTOP) == ACT_PUSHED) {
            	watch_state = STOP;
            } else if (Button_GetState(&hBtnLeft) == ACT_PUSHED) {
                watch_state = LEFT;
            }
            break;
        }
    }

    return 0;
}

void ap_init()
{
    SystemClock_init();

    Button_Init(&hBtnLeft, GPIOB, 5);
    Button_Init(&hBtnRight, GPIOB, 3);
    Button_Init(&hBtnOnSTOP, GPIOA, 10);

    FND_Init();

    //TIM2 EN, TIM2INTRF
    TIM_Init(TIM2, 16 - 1, 1000 - 1);
    TIM_CntStart(TIM2);
    TIM_UIEnable(TIM2);
    NVIC_EnableIRQ(TIM2_IRQn); // TIM2 interruft ENgetTick() - prevCounterTime
}
