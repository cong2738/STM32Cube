/*
 * ap_main.c
 *
 *  Created on: Jun 19, 2025
 *      Author: kccistc
 */

#include "ap_main.h"

enum { START,
    WARCH,
    STOPWATCH };

button_handler_t hBtnA;
button_handler_t hBtnB;
button_handler_t hBtnC;

void TIM2_IRQHandler(void) // 인터럽트 함수 Startup가보면 인터럽트벡터등 이름이 명시되어 있음
{
	incTick();
    FND_DisplayData();
    TIM_ClearUIF(TIM2);
}

int ap_main()
{
	uint32_t ap_state = START;

    uint16_t msec = 0;
    uint16_t sec = 0;
    uint16_t min = 0;

    uint32_t prevCounterTime = 0;
    while (1) {
    	if(getTick() - prevCounterTime >= 100) {
    		prevCounterTime = getTick();
    		msec ++;
    		if(msec == 10){
    			msec = 0;
    			sec++;
    		}
    		if(sec == 60){
    			sec = 0;
    			min++;
    		}
    		if(min == 10){
    			min = 0;
    		}
    	}
        switch (1) {
        case START:
        	ap_state = WATCH;
            break;
        case WARCH:
            if (Button_GetState(&hBtnA) == ACT_PUSHED) {
            	ap_state = STOPWATCH;
            }
            break;
        case STOPWATCH:
            if (Button_GetState(&hBtnA) == ACT_PUSHED) {
            }
            break;
        }
    	FND_WtireData(sec);
    }
    return 0;
}

void ap_init()
{
    SystemClock_init();
    LedBar_Init();
    Button_Init(&hBtnA, GPIOB, 5);
    Button_Init(&hBtnB, GPIOB, 3);
    Button_Init(&hBtnC, GPIOA, 10);
    FND_Init();

    //TIM2 EN, TIM2INTRF
    TIM_Init(TIM2, 16 - 1, 1000 - 1);
    TIM_CntStart(TIM2);
    TIM_UIEnable(TIM2);
    NVIC_EnableIRQ(TIM2_IRQn); // TIM2 interruft EN
}
